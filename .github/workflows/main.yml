name: Build Bootable Mainline Kernel for Miatoll (SM7125)

on:
  workflow_dispatch: # Ручной запуск
    inputs:
      branch_name:
        description: 'Branch to build (usually sm7125-next or master)'
        required: true
        default: 'sm7125-next'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Work Space
      uses: actions/checkout@v4

    - name: Install Build Dependencies & Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
          libwxgtk3.0-gtk3-dev libxml2 libxml2-utils lzop pngcrush \
          rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          python3-pip python3-dev device-tree-compiler lld llvm clang

    - name: Install mkbootimg
      run: |
        pip3 install mkbootimg

    - name: Clone SM7125 Mainline Source
      # Мы используем GitLab репозиторий сообщества, так как в torvalds нет поддержки miatoll
      run: |
        echo "Cloning branch ${{ inputs.branch_name }}..."
        git clone --depth=1 -b ${{ inputs.branch_name }} https://gitlab.com/sm7125-mainline/linux.git kernel_source

    - name: Download Dummy Initramfs
      # Для создания boot.img нужен initramfs. Скачиваем минимальный (от PostmarketOS или подобный)
      # Это позволит ядру загрузиться и выдать лог, даже если Android не запустится.
      run: |
        wget -O initramfs.cpio.gz https://github.com/NotKit/boot-tools/raw/master/images/initramfs-debug.cpio.gz

    - name: Configure Kernel
      working-directory: kernel_source
      env:
        ARCH: arm64
        CC: clang
        CROSS_COMPILE: aarch64-linux-gnu-
        CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
        LLVM: 1
      run: |
        # Используем дефолтный конфиг для Qualcomm
        make qcom_defconfig

    - name: Build Kernel (Image.gz + DTB)
      working-directory: kernel_source
      env:
        ARCH: arm64
        CC: clang
        CROSS_COMPILE: aarch64-linux-gnu-
        CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
        LLVM: 1
      run: |
        echo "Compiling Kernel..."
        make -j$(nproc) Image.gz dtbs

    - name: Prepare Boot Image Components
      working-directory: kernel_source
      run: |
        mkdir -p ../out
        
        # 1. Находим DTB для Miatoll. Имя может отличаться, ищем по шаблону sm7125
        # Обычно это sm7125-xiaomi-miatoll.dtb или sm7125-xiaomi-curtana.dtb
        DTB_FILE=$(find arch/arm64/boot/dts/qcom/ -name "*miatoll*.dtb" | head -n 1)
        
        if [ -z "$DTB_FILE" ]; then
            echo "WARNING: Specific Miatoll DTB not found. Looking for generic SM7125..."
            DTB_FILE=$(find arch/arm64/boot/dts/qcom/ -name "sm7125*.dtb" | head -n 1)
        fi
        
        echo "Using DTB: $DTB_FILE"
        cp arch/arm64/boot/Image.gz ../out/
        cp "$DTB_FILE" ../out/dtb.img
        cp ../initramfs.cpio.gz ../out/
        
        # 2. Appended DTB (соединяем ядро и дерево устройств)
        # Это повышает совместимость с загрузчиком
        cat arch/arm64/boot/Image.gz "$DTB_FILE" > ../out/Image.gz-dtb

    - name: Pack boot.img
      run: |
        cd out
        
        # Параметры командной строки для отладки
        CMDLINE="console=ttyMSM0,115200n8 earlycon=msm_geni_serial,0x4a90000 clk_ignore_unused pd_ignore_unused"
        
        # Создаем образ. Оффсеты стандартные для QCOM, но могут требовать уточнений
        mkbootimg \
          --kernel Image.gz-dtb \
          --ramdisk initramfs.cpio.gz \
          --base 0x00000000 \
          --pagesize 4096 \
          --cmdline "$CMDLINE" \
          -o boot.img
          
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: miatoll-mainline-boot
        path: out/
