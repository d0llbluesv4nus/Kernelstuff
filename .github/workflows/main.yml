name: Build Bootable Mainline Kernel for Miatoll (SM7125)

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch to build (sm7125-next is recommended)'
        required: true
        default: 'sm7125-next'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Work Space
      uses: actions/checkout@v4

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        # Убраны все лишние пакеты, вызывавшие ошибки (step-ca, bird и т.д.)
        sudo apt-get install -y \
          bc bison build-essential curl flex git gnupg gperf \
          libncurses5-dev libssl-dev libxml2 libxml2-utils \
          lzop python3 python3-pip zip zlib1g-dev \
          device-tree-compiler lld llvm clang gcc-aarch64-linux-gnu

    - name: Install mkbootimg
      run: |
        # Установка через прямой скрипт, как мы и решили
        sudo curl -sLo /usr/local/bin/mkbootimg https://raw.githubusercontent.com/osm0sis/mkbootimg/master/mkbootimg.py
        sudo chmod +x /usr/local/bin/mkbootimg

    - name: Clone SM7125 Mainline Source
      run: |
        # Используем конфигурацию, которая предотвращает запрос пароля
        git config --global url."https://github.com/".insteadOf git@github.com:
        git config --global url."https://".insteadOf git://
        
        # Клонируем с дополнительными параметрами для стабильности
        git clone --depth=1 -b ${{ github.event.inputs.branch_name }} https://gitlab.com/sm7125-mainline/linux.git kernel_source || \
        git clone --depth=1 -b master https://gitlab.com/sm7125-mainline/linux.git kernel_source

    - name: Download Dummy Initramfs
      run: |
        curl -sLo initramfs.cpio.gz https://github.com/NotKit/boot-tools/raw/master/images/initramfs-debug.cpio.gz

    - name: Configure Kernel
      working-directory: kernel_source
      run: |
        # Явное указание архитектуры и инструментов
        make ARCH=arm64 LLVM=1 qcom_defconfig

    - name: Build Kernel (Image.gz + DTB)
      working-directory: kernel_source
      run: |
        # Основной этап сборки
        make -j$(nproc) ARCH=arm64 LLVM=1 Image.gz dtbs

    - name: Prepare Artifacts
      run: |
        mkdir -p out
        # Поиск и копирование DTB
        DTB_PATH=$(find kernel_source/arch/arm64/boot/dts/qcom/ -name "*miatoll*.dtb" | head -n 1)
        if [ -z "$DTB_PATH" ]; then
          DTB_PATH=$(find kernel_source/arch/arm64/boot/dts/qcom/ -name "sm7125*.dtb" | head -n 1)
        fi
        
        echo "Found DTB at: $DTB_PATH"
        cat kernel_source/arch/arm64/boot/Image.gz "$DTB_PATH" > out/Image.gz-dtb
        cp "$DTB_PATH" out/dtb.img

    - name: Pack boot.img
      run: |
        # Финальная упаковка в формат Android Boot Image
        python3 /usr/local/bin/mkbootimg \
          --kernel out/Image.gz-dtb \
          --ramdisk initramfs.cpio.gz \
          --base 0x00000000 \
          --pagesize 4096 \
          --cmdline "console=ttyMSM0,115200n8 earlycon=msm_geni_serial,0x4a90000 clk_ignore_unused pd_ignore_unused" \
          -o out/boot.img
          
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: miatoll-boot-image-${{ github.event.inputs.branch_name }}
        path: out/
